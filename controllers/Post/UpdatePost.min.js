const mysql=require("mysql");const MysqlData=require("../../models/MysqlData");const connection=mysql.createConnection((new MysqlData).getConnection());const escapeHtml=require("escape-html");const Aes256=require("../../lib/Aes256");const Sha512=require("../../lib/Sha512");const filterHtml=require("../../lib/filterHtml").filterHtml;module.exports=class UpdatePost{constructor(postId,userId,title,originalPassword,password,content){this.postId=postId;this.userId=userId;this.encryptedUserId=new Aes256(this.userId,"plain").getEncrypted();this.title=title;this.originalPassword=originalPassword;this.password=password;this.content=content}post(){return new Promise((resolve,reject)=>{connection.query("SELECT `id`\n"+"    FROM accounts\n"+"    WHERE `index`= (\n"+"        SELECT `author`\n"+"            FROM posts\n"+"            WHERE\n"+"                `index`=? AND\n"+"                `password`=?\n"+"    );",[this.postId,new Sha512(this.originalPassword).getEncrypted()],(error,accountResult,fields)=>{if(error){throw error}if(accountResult.length>0){if(accountResult[0].id===this.encryptedUserId){connection.query("UPDATE `posts`\n"+"    SET\n"+"        `title`=?,\n"+"        `content`=?,\n"+"        `password`=?,\n"+"        `date`=NOW()\n"+"    WHERE `index`=?;",[escapeHtml(this.title),filterHtml(this.content),new Sha512(this.password).getEncrypted(),this.postId],(error,result,fields)=>{if(error){throw error}resolve()})}else{reject("invalid-user")}}else{reject("no-row")}})})}};
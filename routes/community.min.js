const express=require("express");const bodyParser=require("body-parser");const expressSession=require("express-session");const RedisStore=require("connect-redis")(expressSession);const RedisData=require("../models/RedisData");const redisClient=(new RedisData).getClient();const ReadPost=require("../controllers/Post/ReadPost");const CreatePost=require("../controllers/Post/CreatePost");const ReadPostList=require("../controllers/PostList/ReadPostList");const Sha512=require("../lib/Sha512");const CheckPostOwner=require("../controllers/Post/CheckPostOwner");const Aes256=require("../lib/Aes256");const fetch=require("node-fetch");const morgan=require("morgan");const communityRouter=express.Router();communityRouter.use(bodyParser.urlencoded({extended:true}));communityRouter.use(bodyParser.json());communityRouter.use(bodyParser.raw());communityRouter.use(expressSession({secret:"f%*JNsNn!tFfdqog#Ba7oITKgLW0YYKOm1ARil6MW#BKlmMSrC@LSZnA5E#0!EY63#R%U!NH1#PM4AV80PVDGQDuQbHgZ%&5BEN",resave:false,saveUninitialized:true,store:new RedisStore({client:redisClient,resave:false,saveUninitialized:true}),cookie:{secure:true,name:".bhsjp.kro.kr",domain:"bhsjp.kro.kr",httpOnly:true,maxAge:1e3*60*60*24}}));communityRouter.use(morgan(':remote-addr - :remote-user [:date[iso]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'));communityRouter.get("/",(req,res)=>{res.render("community/index",{title:"커뮤니티",isSignedIn:!!req.session.user})});communityRouter.get("/view-posts/:postListCount",(req,res)=>{const readPostList=new ReadPostList(req.params.postListCount);if(req.params.postListCount!==undefined){if(req.params.postListCount.match(/^\d+$/)){const postListCount=parseInt(req.params.postListCount);readPostList.list().then(postItems=>{readPostList.count().then(postCount=>{res.render("community/view-posts",{title:"글 보기",isSignedIn:!!req.session.user,postItems:postItems,postListCount:postListCount,postCount:postCount})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/do-post-list-exist",(req,res)=>{const postList=req.body.postList;const readPostList=new ReadPostList(postList);if(postList.match(/^\d+$/)){readPostList.list().then(()=>{res.send("ok")},()=>{res.send("no-list")}).catch(error=>{console.error(error);res.send("error")})}else{res.send("number-format-not-match")}});communityRouter.get("/read-post/:postId",(req,res)=>{const postId=req.params.postId;const readPost=new ReadPost(postId);if(postId.match(/^\d+$/)){readPost.title().then(title=>{if(req.session.user){const checkPostOwner=new CheckPostOwner(postId,req.session.user.id);checkPostOwner.check().then(owner=>{res.render("community/read-post",{title:title,isSignedIn:req.session.user,postId:postId,owner:owner})})}else{res.render("community/read-post",{title:title,isSignedIn:req.session.user,postId:postId})}},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/get-post",(req,res)=>{const postId=req.body.postId;const userPassword=req.body.password;const readPost=new ReadPost(postId);readPost.password().then(dbPassword=>{if(dbPassword===null||dbPassword===new Sha512(userPassword).getEncrypted()){readPost.post().then(result=>{res.send({result:"right",data:{title:result.title,nickname:new Aes256(result.nickname,"encrypted").getPlain(),date:result.date,content:result.content}})},reason=>{res.send({result:"no-post"})}).catch(error=>{console.error(error);res.send({result:"error"})})}else{res.send({result:"wrong"})}},reason=>{res.send({result:"no-post"})}).catch(error=>{console.error(error);res.send({result:"error"})})});communityRouter.get("/new-post",(req,res)=>{res.render("community/new-post",{title:"새 글 작성",isSignedIn:!!req.session.user})});communityRouter.post("/create-post",(req,res)=>{const title=req.body.title;const password=req.body.password;const content=req.body.content;const createPost=new CreatePost(req.session.user.id,title,password.length>0?password:null,content);if(req.session.user){if(title.length===0){res.send("empty-title")}else if(content.replace(/<.*?>/g,"").length===0){res.send("empty-content")}else{createPost.post().then(()=>{res.send("ok")}).catch(error=>{console.error(error);res.send("error")})}}else{res.send("not-signed-in")}});communityRouter.get("/fix-post/:postId",(req,res)=>{const postId=req.params.postId;const readPost=new ReadPost(postId);if(postId.match(/^\d+$/)){readPost.title().then(title=>{if(req.session.user){const checkPostOwner=new CheckPostOwner(postId,req.session.user.id);checkPostOwner.check().then(owner=>{if(owner){res.render("community/fix-post",{title:"글 수정",isSignedIn:req.session.user,postId:postId,owner:owner})}else{res.render("errors/403",{title:"403 Forbidden",isSignedIn:!!req.session.user})}})}else{res.render("errors/403",{title:"403 Forbidden",isSignedIn:!!req.session.user})}},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/update-post",(req,res)=>{});communityRouter.post("delete-post",(req,res)=>{});communityRouter.post("/create-comment",(req,res)=>{});communityRouter.post("/update-comment",(req,res)=>{});communityRouter.post("/delete-post",(req,res)=>{});communityRouter.get("/*",(req,res)=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})});module.exports={router:communityRouter};
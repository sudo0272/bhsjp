const express=require("express");const bodyParser=require("body-parser");const expressSession=require("express-session");const RedisStore=require("connect-redis")(expressSession);const redisClient=require("../models/getRedisClient").getRedisClient();const getPostList=require("../controllers/getPostList").getPostList;const getPostCount=require("../controllers/getPostCount").getPostCount;const getPostTitle=require("../controllers/getPostTitle").getPostTitle;const getPostPassword=require("../controllers/getPostPassword").getPostPassword;const getPost=require("../controllers/getPost").getPost;const encryptSha512=require("../models/encryptSha512").encryptSha512;const communityRouter=express.Router();communityRouter.use(bodyParser.urlencoded({extended:true}));communityRouter.use(bodyParser.json());communityRouter.use(bodyParser.raw());communityRouter.use(expressSession({secret:"f%*JNsNn!tFfdqog#Ba7oITKgLW0YYKOm1ARil6MW#BKlmMSrC@LSZnA5E#0!EY63#R%U!NH1#PM4AV80PVDGQDuQbHgZ%&5BEN",resave:false,saveUninitialized:true,store:new RedisStore({client:redisClient,resave:false,saveUninitialized:true}),cookie:{secure:true,name:".bhsjp.kro.kr",domain:"bhsjp.kro.kr",httpOnly:true,maxAge:1e3*60*60*24}}));communityRouter.get("/",(req,res)=>{res.render("community/index",{title:"커뮤니티",isSignedIn:!!req.session.user})});communityRouter.get("/view-posts/:postListCount",(req,res)=>{if(req.params.postListCount!==undefined){if(req.params.postListCount.match(/^\d+$/)){const postListCount=parseInt(req.params.postListCount);getPostList(postListCount,postItems=>{if(postItems.length>0){getPostCount(postCount=>{res.render("community/view-posts",{title:"글 보기",isSignedIn:!!req.session.user,postItems:postItems,postListCount:postListCount,postCount:postCount})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.get("/read-post/:postId",(req,res)=>{const postId=req.params.postId;if(postId.match(/^\d+$/)){getPostTitle(postId,result=>{if(result.length>0){res.render("community/read-post",{title:result[0].title,isSignedIn:req.session.user,postId:postId})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/get-post",(req,res)=>{const postId=req.body.postId;const password=req.body.password;console.log("postId:",postId);getPostPassword(postId,result=>{if(result.length>0){if(result[0].password===null||result[0].password===encryptSha512(password)){getPost(postId).then(result=>{res.send({result:"right",data:{nickname:result[0].nickname,date:result[0].date,content:result[0].content}})}).catch(error=>{res.send("error");console.error(error)})}else{res.send({result:"wrong"})}}else{res.send({result:"no-post"})}})});communityRouter.get("/write-post",(req,res)=>{});communityRouter.post("/create-post",(req,res)=>{});communityRouter.post("/update-post",(req,res)=>{});communityRouter.post("delete-post",(req,res)=>{});communityRouter.post("/create-comment",(req,res)=>{});communityRouter.post("/update-comment",(req,res)=>{});communityRouter.post("/delete-post",(req,res)=>{});communityRouter.get("/*",(req,res)=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})});module.exports={router:communityRouter};
const express=require("express");const bodyParser=require("body-parser");const expressSession=require("express-session");const RedisStore=require("connect-redis")(expressSession);const RedisData=require("../models/RedisData");const redisClient=(new RedisData).getClient();const ReadPost=require("../controllers/Post/ReadPost");const CreatePost=require("../controllers/Post/CreatePost");const UpdatePost=require("../controllers/Post/UpdatePost");const DeletePost=require("../controllers/Post/DeletePost");const ReadPostList=require("../controllers/PostList/ReadPostList");const CreateComment=require("../controllers/Comment/CreateComment");const UpdateComment=require("../controllers/Comment/UpdateComment");const CommentList=require("../controllers/CommentList");const Sha512=require("../lib/Sha512");const CheckPostOwner=require("../controllers/Post/CheckPostOwner");const Aes256=require("../lib/Aes256");const fetch=require("node-fetch");const morgan=require("morgan");const communityRouter=express.Router();communityRouter.use(bodyParser.urlencoded({extended:true}));communityRouter.use(bodyParser.json());communityRouter.use(bodyParser.raw());communityRouter.use(expressSession({secret:"f%*JNsNn!tFfdqog#Ba7oITKgLW0YYKOm1ARil6MW#BKlmMSrC@LSZnA5E#0!EY63#R%U!NH1#PM4AV80PVDGQDuQbHgZ%&5BEN",resave:false,saveUninitialized:true,store:new RedisStore({client:redisClient,resave:false,saveUninitialized:true}),cookie:{secure:true,name:".bhsjp.kro.kr",domain:"bhsjp.kro.kr",httpOnly:true,maxAge:1e3*60*60*24}}));communityRouter.use(morgan(':remote-addr - :remote-user [:date[iso]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'));morgan.token("remote-user",(req,res)=>{return req.session&&req.session.user?req.session.user.id:"-"});communityRouter.get("/",(req,res)=>{res.render("community/index",{title:"커뮤니티",isSignedIn:!!req.session.user})});communityRouter.get("/view-posts/:postListCount",(req,res)=>{const readPostList=new ReadPostList(req.params.postListCount);if(req.params.postListCount!==undefined){if(req.params.postListCount.match(/^\d+$/)){const postListCount=parseInt(req.params.postListCount);readPostList.list().then(postItems=>{readPostList.count().then(postCount=>{res.render("community/view-posts",{title:"글 보기",isSignedIn:!!req.session.user,postItems:postItems,postListCount:postListCount,postCount:postCount})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/do-post-list-exist",(req,res)=>{const postList=req.body.postList;const readPostList=new ReadPostList(postList);if(postList.match(/^\d+$/)){readPostList.list().then(()=>{res.send("ok")},()=>{res.send("no-list")}).catch(error=>{console.error(error);res.send("error")})}else{res.send("number-format-not-match")}});communityRouter.get("/read-post/:postId",(req,res)=>{const postId=req.params.postId;const readPost=new ReadPost(postId);if(postId.match(/^\d+$/)){readPost.title().then(title=>{if(req.session.user){const checkPostOwner=new CheckPostOwner(postId,req.session.user.id);checkPostOwner.check().then(owner=>{res.render("community/read-post",{title:title,isSignedIn:req.session.user,postId:postId,owner:owner})})}else{res.render("community/read-post",{title:title,isSignedIn:req.session.user,postId:postId})}},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/get-post",(req,res)=>{const postId=req.body.postId;const userPassword=req.body.password;const needComments=req.body.needComments;const readPost=new ReadPost(postId);const commentList=new CommentList(postId);readPost.password().then(dbPassword=>{if(dbPassword===new Sha512(userPassword).getEncrypted()){readPost.post().then(post=>{if(needComments){commentList.getFromPostId(postId).then(comments=>{let plainComments=comments;Promise.all([...Array(plainComments.length).keys()].map(i=>{return new Promise(resolve=>{let decryptedNickname=new Aes256(plainComments[i].nickname,"encrypted").getPlain();plainComments[i].nickname=decryptedNickname;if(req.session&&req.session.user){if(req.session.user.id===decryptedNickname){plainComments[i].userPermission="writer";resolve()}else{const checkPostOwner=new CheckPostOwner(postId,req.session.user.id);checkPostOwner.check().then(owner=>{if(owner){plainComments[i].userPermission="postOwner";resolve()}else{if(plainComments[i].isPrivate){plainComments[i].content=`\n                                                                    <div>\n                                                                        <i class="material-icons">\n                                                                            lock\n                                                                        </i>\n                                                                        비밀 댓글입니다\n                                                                    </div>\n                                                                `}plainComments[i].userPermission="none";resolve()}}).catch(error=>{throw error})}}else{if(plainComments[i].isPrivate){plainComments[i].content=`\n                                                    <div>\n                                                        <i class="material-icons">\n                                                            lock\n                                                        </i>\n                                                        비밀 댓글입니다\n                                                    </div>\n                                                `}plainComments[i].userPermission="none";resolve()}})})).then(()=>{res.send({result:"right",data:{title:post.title,nickname:new Aes256(post.nickname,"encrypted").getPlain(),date:post.date,content:post.content,isModified:post.isModified,comments:plainComments}})}).catch(error=>{console.error(error);res.send({result:"error"})})}).catch(error=>{console.error(error);res.send("error")})}else{res.send({result:"right",data:{title:post.title,nickname:new Aes256(post.nickname,"encrypted").getPlain(),date:post.date,content:post.content,isModified:post.isModified}})}},reason=>{res.send({result:"no-post"})}).catch(error=>{console.error(error);res.send({result:"error"})})}else{res.send({result:"wrong"})}},reason=>{res.send({result:"no-post"})}).catch(error=>{console.error(error);res.send({result:"error"})})});communityRouter.get("/new-post",(req,res)=>{res.render("community/new-post",{title:"새 글 작성",isSignedIn:!!req.session.user})});communityRouter.post("/create-post",(req,res)=>{const title=req.body.title;const password=req.body.password;const content=req.body.content;const createPost=new CreatePost(req.session.user.id,title,password,content);if(req.session.user){if(title.length===0){res.send("empty-title")}else if(content.replace(/<.*?>/g,"").length===0){res.send("empty-content")}else{createPost.post().then(()=>{res.send("ok")}).catch(error=>{console.error(error);res.send("error")})}}else{res.send("not-signed-in")}});communityRouter.get("/fix-post/:postId",(req,res)=>{const postId=req.params.postId;const readPost=new ReadPost(postId);if(postId.match(/^\d+$/)){readPost.title().then(title=>{if(req.session.user){const checkPostOwner=new CheckPostOwner(postId,req.session.user.id);checkPostOwner.check().then(owner=>{if(owner){res.render("community/fix-post",{title:"글 수정",isSignedIn:req.session.user,postId:postId,owner:owner})}else{res.render("errors/403",{title:"403 Forbidden",isSignedIn:!!req.session.user})}})}else{res.render("errors/403",{title:"403 Forbidden",isSignedIn:!!req.session.user})}},reason=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}).catch(error=>{console.error(error);res.render("errors/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})}else{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})}});communityRouter.post("/update-post",(req,res)=>{const title=req.body.title;const originalPassword=req.body.originalPassword;const password=req.body.password;const content=req.body.content;const postId=req.body.postId;const updatePost=new UpdatePost(postId,req.session.user.id,title,originalPassword,password,content);if(req.session.user){if(title.length===0){res.send("empty-title")}else if(content.replace(/<.*?>/g,"").length===0){res.send("empty-content")}else{updatePost.post().then(()=>{res.send("ok")},reason=>{switch(reason){case"no-row":res.send("no-post");break;case"invalid-user":res.send("invalid-user");break}}).catch(error=>{console.error(error);res.send("error")})}}else{res.send("not-signed-in")}});communityRouter.post("/delete-post",(req,res)=>{const postId=req.body.postId;const password=req.body.password;const deletePost=new DeletePost(postId,req.session.user.id,password);if(req.session.user){deletePost.post().then(()=>{res.send("ok")},reason=>{res.send(reason)}).catch(error=>{console.error(error);res.send("error")})}else{res.send("not-signed-in")}});communityRouter.post("/create-comment",(req,res)=>{const content=req.body.content;const isPrivateComment=req.body.isPrivateComment;const postId=req.body.postId;if(req.session.user){const comment=new CreateComment(req.session.user.index,postId,content,isPrivateComment);comment.create().then(()=>{res.send("ok")}).catch(()=>{res.send("error")})}else{res.send("not-signed-in")}});communityRouter.post("/update-comment",(req,res)=>{const commentId=req.body.commentId;const content=req.body.content;const isPrivate=req.body.isPrivate;if(req.session.user){const updateComment=new UpdateComment(req.session.user.index,commentId,content,isPrivate);updateComment.update().then(()=>{res.send("ok")},reason=>{res.send(reason)}).catch(error=>{console.error(error);res.send("error")})}else{res.send("not-signed-in")}});communityRouter.post("/delete-post",(req,res)=>{});communityRouter.get("/*",(req,res)=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})});module.exports={router:communityRouter};
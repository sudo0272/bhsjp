const express=require("express");const bodyParser=require("body-parser");const CheckAccount=require("../controllers/Account/CheckAccount");const CreateAccount=require("../controllers/Account/CreateAccount");const expressSession=require("express-session");const cors=require("cors");const RedisStore=require("connect-redis")(expressSession);const RedisData=require("../models/RedisData");const redisClient=(new RedisData).getClient();const morgan=require("morgan");const Aes256=require("../lib/Aes256");const corsWhiteList=["https://bhsjp.kro.kr","https://introduce.bhsjp.kro.kr","https://accounts.bhsjp.kro.kr","https://community.bhsjp.kro.kr"];const accountsRouter=express.Router();accountsRouter.use(bodyParser.urlencoded({extended:true}));accountsRouter.use(bodyParser.json());accountsRouter.use(bodyParser.raw());accountsRouter.use(expressSession({secret:"f%*JNsNn!tFfdqog#Ba7oITKgLW0YYKOm1ARil6MW#BKlmMSrC@LSZnA5E#0!EY63#R%U!NH1#PM4AV80PVDGQDuQbHgZ%&5BEN",resave:false,saveUninitialized:true,store:new RedisStore({client:redisClient,resave:false,saveUninitialized:true}),cookie:{secure:true,name:".bhsjp.kro.kr",domain:"bhsjp.kro.kr",httpOnly:true,maxAge:1e3*60*60*24}}));accountsRouter.use(morgan(':remote-addr - :remote-user [:date[iso]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'));morgan.token("remote-user",(req,res)=>{return req.session?req.session.user.id:"-"});accountsRouter.all("/*",(req,res,next)=>{res.header("Access-Control-Allow-Origin",corsWhiteList);res.header("Access-Control-Allow-Headers","X-Requested-With");res.header("Access-Control-Allow-Credentials","true");next()});accountsRouter.get("/",(req,res)=>{res.render("accounts/index",{title:"계정",isSignedIn:!!req.session.user})});accountsRouter.get("/sign-in",(req,res)=>{res.render("accounts/sign-in",{title:"로그인",isSignedIn:!!req.session.user})});accountsRouter.get("/sign-up",(req,res)=>{res.render("accounts/sign-up",{title:"회원가입",isSignedIn:!!req.session.user})});accountsRouter.post("/create-account",(req,res)=>{const id=req.body.id;const password=req.body.password;const nickname=req.body.nickname;const email=req.body.email;if(id===undefined){res.send("no-id")}else if(id.length<1){res.send("id-length-short")}else if(id.length>10){res.send("id-length-long")}else if(id.match(/^\w{1,10}$/g)===null){res.send("id-template-not-match")}else if(password===undefined){res.send("no-password")}else if(password.length<4){res.send("password-length-short")}else if(nickname===undefined){res.send("no-nickname")}else if(nickname.length<1){res.send("nickname-length-short")}else if(nickname.length>10){res.send("nickname-length-long")}else if(email===undefined){res.send("no-email")}else if(email.length<3){res.send("email-length-short")}else if(email.length>320){res.send("email-length-long")}else if(email.match(/^[^@]{1,64}@[^@]{1,255}$/)===null){res.send("email-template-not-match")}else{const checkAccount=new CheckAccount(id);checkAccount.id().then(()=>{res.send("id-already-exists")},()=>{const createAccount=new CreateAccount(id,password,nickname,email);createAccount.create().then(()=>{res.send("ok")}).catch(error=>{console.error(error);res.send("error")})})}});accountsRouter.post("/check-account",(req,res)=>{const id=req.body.id;const password=req.body.password;if(id===undefined){res.send("no-id")}else if(id.length<1){res.send("id-length-short")}else if(id.length>10){res.send("id-length-long")}else if(id.match(/^\w{1,10}$/g)===null){res.send("id-template-not-match")}else if(password===undefined){res.send("no-password")}else if(password.length<4){res.send("password-length-short")}else{const checkAccount=new CheckAccount(id,password);checkAccount.account().then(accountData=>{if(req.session.user){res.send("already-signed-in")}else{req.session.user={id:new Aes256(accountData.id,"encrypted").getPlain(),nickname:new Aes256(accountData.nickname,"encrypted").getPlain(),email:new Aes256(accountData.email,"encrypted").getPlain()};res.send("ok")}},()=>{setTimeout(()=>{res.send("wrong")},3e3)}).catch(error=>{console.error(error);res.send("error")})}});accountsRouter.post("/sign-out",cors({origin:(origin,callback)=>{if(corsWhiteList.indexOf(origin)!==-1){callback(null,true)}else{callback(new Error("Not allowed by CORS"))}}}),(req,res)=>{if(req.session.user){req.session.destroy(error=>{if(error){res.send("cannot-sign-out")}else{res.send("ok")}})}else{res.send("not-signed-in")}});accountsRouter.get("/*",(req,res)=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})});module.exports={router:accountsRouter};
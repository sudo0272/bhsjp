const express=require("express");const bodyParser=require("body-parser");const Account=require("../controllers/Account");const expressSession=require("express-session");const cors=require("cors");const RedisStore=require("connect-redis")(expressSession);const RedisData=require("../models/RedisData");const SessionData=require("../models/SessionData");const redisClient=(new RedisData).getClient();const morgan=require("morgan");const Aes256=require("../lib/Aes256");const nodemailer=require("nodemailer");const NodemailerData=require("../models/NodemailerData");const corsWhiteList=["https://bhsjp.kro.kr","https://introduce.bhsjp.kro.kr","https://accounts.bhsjp.kro.kr","https://community.bhsjp.kro.kr"];const sessionData=new SessionData;const accountsRouter=express.Router();accountsRouter.use(bodyParser.urlencoded({extended:true}));accountsRouter.use(bodyParser.json());accountsRouter.use(bodyParser.raw());accountsRouter.use(expressSession({secret:sessionData.getSecret(),resave:sessionData.getResave(),saveUninitialized:sessionData.getSaveUninitialized(),store:eval(sessionData.getStore()),cookie:{secure:sessionData.getCookieSecure(),name:sessionData.getCookieName(),domain:sessionData.getCookieDomain(),httpOnly:sessionData.getCookieHttpOnly(),maxAge:sessionData.getMaxAge()}}));accountsRouter.use(morgan(':remote-addr - :remote-user [:date[iso]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'));morgan.token("remote-user",(req,res)=>{return req.session&&req.session.user?req.session.user.id:"-"});accountsRouter.all("/*",(req,res,next)=>{res.header("Access-Control-Allow-Origin",corsWhiteList);res.header("Access-Control-Allow-Headers","X-Requested-With");res.header("Access-Control-Allow-Credentials","true");next()});accountsRouter.get("/",(req,res)=>{res.render("accounts/index",{title:"계정",isSignedIn:!!req.session.user})});accountsRouter.get("/sign-in",(req,res)=>{res.render("accounts/sign-in",{title:"로그인",isSignedIn:!!req.session.user})});accountsRouter.get("/sign-up",(req,res)=>{res.render("accounts/sign-up",{title:"회원가입",isSignedIn:!!req.session.user})});accountsRouter.post("/create-account",(req,res)=>{const id=req.body.id;const password=req.body.password;const nickname=req.body.nickname;const email=req.body.email;const account=new Account;if(id===undefined){res.send("no-id")}else if(id.length<1){res.send("id-length-short")}else if(id.length>10){res.send("id-length-long")}else if(id.match(/^\w{1,10}$/g)===null){res.send("id-template-not-match")}else if(password===undefined){res.send("no-password")}else if(password.length<4){res.send("password-length-short")}else if(nickname===undefined){res.send("no-nickname")}else if(nickname.length<1){res.send("nickname-length-short")}else if(nickname.length>10){res.send("nickname-length-long")}else if(email===undefined){res.send("no-email")}else if(email.length<3){res.send("email-length-short")}else if(email.length>320){res.send("email-length-long")}else if(email.match(/^[^@]{1,64}@[^@]{1,255}$/)===null){res.send("email-template-not-match")}else{account.doIdExist(id).then(()=>{res.send("id-already-exists")},()=>{account.create(id,password,nickname,email).then(()=>{const nodemailerData=new NodemailerData;const userCertificationAddress="https://accounts.bhsjp.kro.kr/auth/"+new Aes256(id,"plain",nodemailerData.getUserCertificationKey(),nodemailerData.getUserCertificationIv()).getEncrypted();let transporter=nodemailer.createTransport({service:nodemailerData.getService(),auth:{user:nodemailerData.getEmailAddress(),pass:nodemailerData.getPassword()}});transporter.sendMail({from:nodemailerData.getEmailAddress(),to:email,subject:"BHSJP 인증 메일",html:`\n                                <h1>BHSJP의 회원이 되신 것을 축하드립니다</h1>\n                                <h3><a href="${userCertificationAddress}">여기</a>를 클릭하시거나 "${userCertificationAddress}" 로 직접 들어가서 인증해주시기 바랍니다</h3>\n                            `});res.send("ok")}).catch(error=>{console.error(error);res.send("error")})})}});accountsRouter.post("/check-account",(req,res)=>{const id=req.body.id;const password=req.body.password;const account=new Account;if(id===undefined){res.send("no-id")}else if(id.length<1){res.send("id-length-short")}else if(id.length>10){res.send("id-length-long")}else if(id.match(/^\w{1,10}$/g)===null){res.send("id-template-not-match")}else if(password===undefined){res.send("no-password")}else if(password.length<4){res.send("password-length-short")}else{account.doAccountExist(id,password).then(accountData=>{if(req.session.user){res.send("already-signed-in")}else{account.isVerified(accountData.index).then(isVerified=>{if(isVerified){req.session.user={id:new Aes256(accountData.id,"encrypted").getPlain(),nickname:new Aes256(accountData.nickname,"encrypted").getPlain(),email:new Aes256(accountData.email,"encrypted").getPlain(),index:accountData.index};res.send("ok")}else{res.send("not-verified")}}).catch(error=>{console.error(error);res.send("error")})}},()=>{setTimeout(()=>{res.send("wrong")},3e3)}).catch(error=>{console.error(error);res.send("error")})}});accountsRouter.post("/sign-out",cors({origin:(origin,callback)=>{if(corsWhiteList.indexOf(origin)!==-1){callback(null,true)}else{callback(new Error("Not allowed by CORS"))}}}),(req,res)=>{if(req.session.user){req.session.destroy(error=>{if(error){res.send("cannot-sign-out")}else{res.send("ok")}})}else{res.send("not-signed-in")}});accountsRouter.get("/auth/:verificationCode",(req,res)=>{const verificationCode=req.params.verificationCode;const nodemailerData=new NodemailerData;const account=new Account;const id=new Aes256(verificationCode,"encrypted",nodemailerData.getUserCertificationKey(),nodemailerData.getUserCertificationIv()).getPlain();console.log(verificationCode);console.log(new Aes256(verificationCode,"encrypted",nodemailerData.getUserCertificationKey(),nodemailerData.getUserCertificationIv()).getPlain());account.doIdExist(id).then(()=>{console.log("1");account.getIndexByEncryptedId(new Aes256(id,"plain").getEncrypted()).then(index=>{console.log("2");account.setToVerified(index).then(()=>{console.log("3");res.render("accounts/verification-success",{title:"인증 성공",isSignedIn:!!req.session.user})}).catch(error=>{console.error(error);res.render("error/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})},()=>{res.render("accounts/verification-failure",{title:"인증 실패",isSignedIn:!!req.session.user})}).catch(error=>{console.error(error);res.render("error/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})},()=>{res.render("accounts/verification-failure",{title:"인증 실패",isSignedIn:!!req.session.user})}).catch(error=>{console.error(error);res.render("error/500",{title:"500 Internal Server Error",isSignedIn:!!req.session.user})})});accountsRouter.get("/find-id",(req,res)=>{res.render("accounts/find-id",{title:"아이디 찾기",isSignedIn:req.session.user})});accountsRouter.post("/id-lookup",(req,res)=>{const account=new Account;const email=req.body.email;console.log(new Aes256(email,"plain").getEncrypted());account.getIndexByEncryptedEmail(new Aes256(email,"plain").getEncrypted()).then(index=>{account.getDataByIndex(index).then(data=>{const nodemailerData=new NodemailerData;const id=new Aes256(data.id,"encrypted").getPlain();let transporter=nodemailer.createTransport({service:nodemailerData.getService(),auth:{user:nodemailerData.getEmailAddress(),pass:nodemailerData.getPassword()}});transporter.sendMail({from:nodemailerData.getEmailAddress(),to:email,subject:"BHSJP 아이디 찾기",html:`\n                            <h1>BHSJP 아이디 찾기</h1>\n                            <h3>회원님의 아이디는 "${id}" 입니다</h3>\n                        `});res.send("ok")},reason=>{const nodemailerData=new NodemailerData;let transporter=nodemailer.createTransport({service:nodemailerData.getService(),auth:{user:nodemailerData.getEmailAddress(),pass:nodemailerData.getPassword()}});transporter.sendMail({from:nodemailerData.getEmailAddress(),to:email,subject:"BHSJP 아이디 찾기",html:`\n                    <h1>BHSJP 아이디 찾기</h1>\n                    <h3>등록되지 않은 이메일입니다</h3>\n                    <h3>다시 한 번 확인해주세요</h3>\n                `});res.send(reason)}).catch(error=>{console.error(error);res.send("error")})},reason=>{const nodemailerData=new NodemailerData;let transporter=nodemailer.createTransport({service:nodemailerData.getService(),auth:{user:nodemailerData.getEmailAddress(),pass:nodemailerData.getPassword()}});transporter.sendMail({from:nodemailerData.getEmailAddress(),to:email,subject:"BHSJP 아이디 찾기",html:`\n                    <h1>BHSJP 아이디 찾기</h1>\n                    <h3>등록되지 않은 이메일입니다</h3>\n                    <h3>다시 한 번 확인해주세요</h3>\n                `});res.send(reason)}).catch(error=>{console.error(error);res.send("error")})});accountsRouter.get("/find-password",(req,res)=>{res.render("accounts/find-password",{title:"비밀번호 찾기",isSignedIn:req.session.user})});accountsRouter.get("/*",(req,res)=>{res.render("errors/404",{title:"404 Not Found",isSignedIn:req.session.user})});module.exports={router:accountsRouter};